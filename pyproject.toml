[project]
name = "hiku"
dynamic = ["version"]
description = "Library to implement Graph APIs"
readme = {file = "README.rst", content-type = "text/x-rst"}
license = {text = "BSD-3-Clause"}
authors = [
    {name = "Vladimir Magamedov", email = "vladimir@magamedov.com"},
    {name = "Maksym Kindritskyi", email = "kindritskiy.m@gmail.com"},
]
dependencies = []
requires-python = ">=3.7"

classifiers = [
    'Development Status :: 5 - Production/Stable',
    'Intended Audience :: Developers',
    'License :: OSI Approved :: BSD License',
    'Operating System :: OS Independent',
    'Programming Language :: Python',
    'Programming Language :: Python :: 3.7',
    'Programming Language :: Python :: 3.8',
    'Programming Language :: Python :: 3.9',
    'Programming Language :: Python :: 3.10',
    'Programming Language :: Python :: 3.11',
    'Programming Language :: Python :: 3 :: Only',
    'Topic :: Software Development :: Libraries :: Python Modules',
]

[project.urls]
Documentation = "https://hiku.readthedocs.io/en/latest/"
Repository = "https://github.com/evo-company/hiku"
Homepage = "https://github.com/evo-company/hiku"

[build-system]
requires = ["pdm-backend"]
build-backend = "pdm.backend"

[tool.pdm]

[tool.pdm.version]
source = "file"
path = "hiku/__init__.py"

[tool.pdm.build]
includes = [
    "hiku",
    "hiku/pytyped",
]
excludes = [ "tests", "**/.*.*" ]

[tool.pdm.dev-dependencies]
test = [
    "astor==0.8.1",
    "pytest>=7.3.1",
    "pytest-cov>=4.0.0",
    "pytest-asyncio",
    "faker",
    "pytest-benchmark[histogram]>=4.0.0",
    "asyncpg",  # for tests_pg
    "greenlet",  # for tests_pg
]
dev = [
    "graphql-core",  # for graphql support
    "sqlalchemy>=1.3.9,<2.0.0",
    "protobuf<4.0.0",  # for protobuf support
    "aiopg",  # for async postgresql support
    "prometheus-client",  # for prometheus metrics
    "sentry-sdk",  # for sentry tracing
    "typing-extensions",
    "mypy",
    "black",
    "flake8==5.0.4",
]
docs = [
    "sphinx==5.0.2",
    "furo>=2023.3.27",
]
examples = [
    "flask==2.1.3",
    "aiohttp==3.8.4",
]

[tool.pdm.resolution.overrides]
importlib-metadata = ">=4.3"

[tool.pdm.scripts]
bench = "python -m pytest --benchmark-enable {args:tests}"
test = "python -m pytest {args:tests}"
test-pg = "python -m pytest {args:tests_pg}"
test-pg-local = "python -m pytest --pg-host=localhost {args:tests_pg}"
test-all = {composite = ["test", "test-pg"]}
fmt = "python -m black hiku"
mypy = "python -m mypy"
flake = "python -m flake8"
docs = "sphinx-build -b html docs docs/build"
docs-open = "open docs/build/index.html"
check = {composite = ["fmt", "test", "mypy", "flake"]}
example = "python examples/{args:graphql_flask}.py"

[tool.pdm.scripts.release]
shell = """
set -e
USAGE="Usage: VERSION=<> MESSAGE=<> pdm run release"

if [ -z "${VERSION}" ]; then
    echo $USAGE
    echo "VERSION is not set"
    exit 1
fi
if [ -z "${MESSAGE}" ]; then
    echo $USAGE
    echo "MESSAGE is not set"
    exit 1
fi
echo "__version__ = \\"${VERSION}\\"" > hiku/__init__.py
git add hiku/__init__.py
git commit -m "Release ${VERSION}"
git tag -a v${VERSION} -m "${MESSAGE}"
git push origin master --tags
"""
env = {VERSION = "", MESSAGE = ""}

[tool.pytest.ini_options]
addopts = "--tb=native --benchmark-disable"
testpaths = [
    "tests",
    "tests_pg"
]

filterwarnings = [
    "once::DeprecationWarning",
    "once::PendingDeprecationWarning",
    "ignore::DeprecationWarning:graphql.*",
    "ignore::DeprecationWarning:promise.*",
    "ignore::DeprecationWarning:google.*",
    "ignore::DeprecationWarning:sqlalchemy.*",
]

[tool.coverage.run]
branch = true
source = [
    "hiku",
]

[tool.mypy]
files = [
    "hiku",
]
python_version = 3.7
check_untyped_defs = true
#disallow_any_generics = true
#disallow_untyped_calls = true
disallow_untyped_defs = true
follow_imports = "silent"
strict_optional = true
warn_redundant_casts = true
warn_unused_ignores = true
show_error_codes = true
ignore_errors = false

exclude = [
    "tests",
    "tests_pg"
]

[[tool.mypy.overrides]]
module = "hiku.telemetry.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.edn.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.export.simple.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.export.protobuf.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.readers.simple.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.readers.protobuf.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.expr.refs.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.expr.checker.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.expr.compiler.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.sources.sqlalchemy.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.sources.aiopg.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.typedef.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "hiku.builder.*"
disallow_untyped_defs = false
check_untyped_defs = false

[[tool.mypy.overrides]]
module = "google.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "graphql.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "sqlalchemy.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "prometheus_client.*"
ignore_missing_imports = true

[[tool.mypy.overrides]]
module = "sentry_sdk.*"
ignore_missing_imports = true

[tool.black]
line-length = 80
target-version = ['py37']
